#!/bin/sh
# Copyright 2016 The dev Authors. All rights reserved.
# Use of this source code is governed by a BSD-style
# license that can be found in the LICENSE file.

#
# Shell Style Guide: https://google.github.io/styleguide/shell.xml
#
# dev_xxx: Framwork functions, declared in dev.
# glb_xxx: Global variables, declared in dev.
#
# ofn_xxx: Option functions.
# opt_xxx: Option description variables.
# als_xxx: Alias of options.
#
# cfg_xxx: Configurations, declared in config file.
#
# arg_xxx: Arguments for commands, declared in xxx.args files.
#                     For exmpale:
#                         readonly demo_hello="Hello"
#                         demo_world="world"
#
# hlp_xxx: Command help text, declared in xxx.cmd files by user.
# cmd_xxx: Command function, declared in xxx.cmd files by user.
#
# xxx: Local varialbes, declared in xxx.cmd files by user. Declare
#      function-specific variables with local. Declaration and assignment
#      should be on different lines. for example:
#          local file
#          file="/path/to/file/name"
#      or (only in function)
#          declare file="/path/to/file/name"
#

# trace ERR through pipes
set -o pipefail

# set -e : exit the script if any statement returns a non-true return value
set -o errexit

#
# Init a global constaiont
# Useage:
#     dev_const <name> <config-value> <default-value>
#
dev_const() {
    declare the_name="glb_$1"

    if [[ -z "$2" ]]; then
        declare -gr "$the_name=$3"
    else
        declare -gr "$the_name=$2"
    fi
}

#
# Init subdirectory.
# Useage:
#     dev_sub_dir <directory-name> <config-value> <default-value>
#
dev_sub_dir() {
    dev_const "$1" "$2" "$3"

    declare the_name="glb_$1"
    declare the_path="${!the_name}"

    # Create directory
    if [[ ! -d $the_path ]]; then
        mkdir -p $the_path
    fi
}

#
# Useage:
#     dev_wk_dir <dev-path>
#
dev_wk_dir() {
    declare wk_dir="$1"

    if [[ -L "$1" ]]; then
        wk_dir=$(readlink -f "$1")
    fi

    declare -gr glb_wk_dir="$(dirname $(dirname $(realpath $wk_dir)))"
    # echo "Working directory: $glb_wk_dir" >&2
}

#
# Global variables
#
dev_global() {
    # The sudo prefix
    if [[ "$(whoami)" != "root" ]]; then
        declare -gr glb_sudo=""
    else
        declare -gr glb_sudo="sudo"
    fi

    # Include configuration file
    for cfgfile in "/etc/dev.conf", "$HOME/.dev.conf", "$glb_wk_dir/etc/dev.conf"; do
        if [[ -f $cfgfile ]]; then
            . $cfgfile
            break # FIXME support multiple config file.
        fi
    done

    # Command file directory: glb_cmd
    dev_const "cmd" "$cfg_base/cmd" "$glb_wk_dir/cmd"

    # Command file directory: glb_etc
    dev_const "etc" "$cfg_base/etc" "$glb_wk_dir/etc"

    # Log directory: glb_log
    dev_sub_dir "log" "$cfg_base/log" "$glb_wk_dir/log"

    # Var directory: glb_var
    dev_sub_dir "var" "$cfg_base/var" "$glb_wk_dir/var"

    # Private key: glb_private_key
    dev_const "private_key" "$cfg_private_key" "$HOME/.ssh/id_rsa"

    # Is shift the next argument.
    declare -g glb_shift=0

    # Is run command
    declare -g glb_run=1

    # Run level
    # 0: Local machine, 1: Specifies nodes, 2: Specifies group 3: All nodes
    declare -g glb_run_level=0

    # Runs in the background
    declare -g glb_run_in_bg=0

    # Non-dev command
    declare -g glb_sys_cmd=0

    # Command file load status
    declare -g glb_file_loaded=0
}

#
# Prepare command files
#
dev_load_files() {
    # Include bootstrap
    if [[ -f $cfg_base/lib/bootstrap ]]; then
        . $cfg_base/lib/bootstrap
    fi

    # Command file
    if [[ $# -ge 1 && ! -z "$1" ]]; then
        declare -g glb_cmd_path="$glb_cmd/$1"

        if [[ ! -f $glb_cmd_path.cmd ]]; then
            # File not found: $glb_cmd_path.cmd
            return 0
        fi

        # Include arguments
        if [[ -f $glb_etc/dev.d/$1.args ]]; then
            . $glb_etc/dev.d/$1.args
        fi

        # Include variables
        if [[ -f $glb_cmd_path.var ]]; then
            . $glb_cmd_path.var
        fi

        # Include command file
        . $glb_cmd_path.cmd
        glb_file_loaded=1
    fi
}

#
# Execute the command
# Useage:
#     dev_run <command-file> <command-function> [command-options]
#
dev_run() {
    # Execute the command
    if [[ $# -le 0 || -z "$1" ]]; then
        echo "dev: missing <command-file>" >&2
        # dev_help_useage
        # dev_help_files
        # dev_help_options
        return 1
    elif [[ $# -eq 1 || -z "$2" ]]; then
        echo "dev: missing <command-function>" >&2
        # dev_help_useage "$1"
        # dev_help_functions
        # dev_help_options
        return 1
    elif [[ $# -ge 2 ]]; then
        declare cmd=$1
        declare func=${2/-/_}

        if [[ "$(declare -F cmd_$func)" == "cmd_$func" ]]; then
            if [[ $glb_run_level -eq 0 ]]; then
                # Run in local machine
                set -- "${@:3}"
                dev_exec_local "cmd_$func" "$@"
            elif [[ $glb_run_level -eq 1 ]]; then
                # FIXME Run in specifies nodes
                :
            elif [[ $glb_run_level -eq 2 ]]; then
                # FIXME Run in specifies group
                :
            elif [[ $glb_run_level -eq 3 ]]; then
                # Run in all nodes
                # FIXME Verify command exists, checksum.
                # dev_exec "dev_verify_callback" "dev" "-v" $@
                dev_exec "dev_exec_callback" "dev" "-l" $@
            else
                echo "dev: run level error: $glb_run_level" >&2
            fi
        else
            echo "dev: command not found: $func" >&2
            return 1
        fi
    fi
}

#
# Useage:
#     dev_run_sys <system-command> [arguments]
#
dev_run_sys() {
    declare cmd="$1"

    if [[ $glb_run_level -eq 0 ]]; then
        # Run in local machine
        set -- "${@:2}"
        dev_exec_local "$cmd" "$@"
    elif [[ $glb_run_level -eq 1 ]]; then
        # FIXME Run in specifies nodes
        :
    elif [[ $glb_run_level -eq 2 ]]; then
        # FIXME Run in specifies group
        :
    elif [[ $glb_run_level -eq 3 ]]; then
        # Run in all nodes
        # FIXME Verify command exists, checksum.
        # dev_exec "dev_verify_callback" "whereis" $cmd
        dev_exec "dev_exec_callback" "dev" "-l" "-s" $@
    else
        echo "dev: run level error: $glb_run_level" >&2
    fi
}

#
# Useage:
#     dev_exec_local <command> <arguments>...
#
dev_exec_local() {
    declare cmd="$1"

    set -- "${@:2}"

    # $cmd $@ 2>&1 | tee $log_out
    # ($cmd $@ | tee $log_out) 3>&1 1>&2 2>&3 | tee $log_err
    if [[ $glb_run_in_bg -eq 1 ]]; then
        declare log_err
        declare log_out

        declare user="$(whoami)"
        declare host="127.0.0.1"
        declare title="[$user@$host $(date '+%Y-%m-%d %H:%M:%S')] $cmd $@"

        log_out="$glb_log/$host.out"
        log_err="$glb_log/$host.err"

        echo "$title" >> $log_out
        echo "$title" >> $log_err

        nohup $cmd $@ >>$log_out 2>>$log_err &
        echo "PID: $!"
        # echo "out: $(< $log_out)"
        # echo "err: $(< $log_err)"
    else
        $cmd $@
        # echo "$?"
    fi
}

#
# Execute a command from all nodes.
# This method will check dev is exists.
# Useage:
#     dev_exec <callback-function> <system-command> [arguments]
#     dev_exec <callback-function> dev [options] <command-file> <command-function> [command-options]
#
dev_exec() {
    if [[ "${#cfg_nodes[@]}" -le 0 ]]; then
        echo "dev: empty nodes" >&2
        return 1
    fi

    declare callback="$1"
    declare ret
    declare out
    declare err
    declare log_err
    declare log_out

    declare user
    declare host
    declare title

    set -- "${@:2}"

    for node in "${!cfg_nodes[@]}"; do
        user="${cfg_nodes[$node]}"
        host="$node"
        title="[$user@$host $(date '+%Y-%m-%d %H:%M:%S')] $@"

        echo "$title"

        set +o errexit
        # out=$(ssh -t -i $glb_private_key $user@$host "$@" 2>$err_log)
        if [[ $glb_run_in_bg -eq 1 ]]; then
            log_out="$glb_log/$host.out"
            log_err="$glb_log/$host.err"

            echo "$title" >> $log_out
            echo "$title" >> $log_err

            nohup ssh -i $glb_private_key $user@$host "$@" >>$log_out 2>>$log_err &
            echo "PID: $!"
            # echo "out: $(< $log_out)"
            # echo "err: $(< $log_err)"
        else
            # FIXME use coproc
            ssh -i $glb_private_key $user@$host "$@"
            # echo "$?"
        fi
        set -o errexit

        echo ""
    done
}

#
# A function called main is required for scripts long enough to contain at
# least one other function.The last non-comment line in the file should be
# a call to main:
#     main "$@"
#
main() {
    . $glb_wk_dir/lib/help

    # When used in a function, declare and typeset make each name local
    declare -ag functions # functions[] is an local indexed array
    declare counter=0
    declare opt
    declare als
    declare i
    declare j
    declare longopt
    declare args
    declare val

    # Prepare options
    while true ; do
        glb_shift=0
        opt=""
        longopt=0

        if [[ "${1:0:2}" == "--" ]]; then
            opt="${1:2}"
            longopt=1
        elif [[ "${1:0:1}" == "-" ]]; then
            for j in $(compgen -A function); do
                als="als_${j:4}"
                if [[ "${j:0:4}" == "ofn_" && "${!als}" == "${1:1}" ]]; then
                    opt="${j:4}"; break
                fi
            done

            if [[ -z "$opt" ]]; then
                echo "dev: unrecognized option -${1:1}" >&2
            fi
        else
            break
        fi

        shift

        if [[ -z $opt ]]; then
            continue
        fi

        if [[ $longopt -eq 1 ]]; then
            IFS='=' read -ra args <<< "$opt"
            opt=${args[0]}
            val=${args[1]}
        else
            val=$1
        fi

        if [[ "$(declare -F opr_$opt)" == "opr_$opt" ]]; then
            opr_$opt "$val"
            if [[ $glb_shift -eq 1 && $longopt -eq 0 ]]; then
                shift
            fi
        fi

        if [[ "$(declare -F ofn_$opt)" == "ofn_$opt" ]]; then
            functions[$counter]="$opt"
            let "counter += 1"
        fi
    done

    # Prepare files
    if [[ $glb_sys_cmd -eq 0 ]]; then
        dev_load_files $@
    fi

    # Do option functions
    for i in "${functions[@]}"; do
        ofn_${i/-/_} $@
    done

    # Do command function
    if [[ $glb_run -eq 1 ]]; then
        if [[ $glb_sys_cmd -eq 1 ]]; then
            dev_run_sys $@
        else
            if [[ $# -ge 1 && $glb_file_loaded -eq 0 ]]; then
                echo "dev: command file not found: $glb_cmd_path.cmd" >&2
                return 1
            fi

            dev_run $@
        fi
    fi
}


# Call to main function. custom function declare before here.
dev_wk_dir "$0"
dev_global
main $@
