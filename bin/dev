#!/bin/sh
# Copyright 2016 The dev Authors. All rights reserved.
# Use of this source code is governed by a BSD-style
# license that can be found in the LICENSE file.

#
# Shell Style Guide: https://google.github.io/styleguide/shell.xml
#
# dev_xxx: Framwork functions, declared in bin/dev.
# glb_xxx: Global variables, declared in bin/dev.
#
# opa_rem: Optional arguments description variables(readonly).
# opa_als: Alias of optional arguments(readonly).
# opa_fun_xxx: Optional arguments function.
#
# cfg_xxx: Configurations, declared in config file(readonly).
# cmd_xxx: Command function, declared in xxx.sh files by user.
# xxx: Local varialbes, declared in xxx.sh files by user. Declare
#      function-specific variables with local. Declaration and assignment
#      should be on different lines. for example:
#          local file
#          file="/path/to/file/name"
#      or (only in function)
#          declare file="/path/to/file/name"
#

# trace ERR through pipes
set -o pipefail

# set -e : exit the script if any statement returns a non-true return value
set -o errexit


#
# Usage:
#     dev_base
#
dev_base() {
    declare base="$0" cfg

    [ -L "$base" ] && base=$(readlink -f $base)
    base=$(dirname $(realpath $base))

    if [ "$(basename $base)" == "bin" ]; then
        declare -gr glb_base="$(dirname $base)"
    else
        declare -gr glb_base="$base"
    fi

    for cfg in "$glb_base/dev.conf", "$HOME/.dev.conf", "$glb_base/etc/dev.conf"; do
        [ -f $cfg ] && . $cfg && break
    done

    # Private key: glb_ssh_key
    [ -z "$cfg_ssh_key" ] && declare -gr glb_ssh_key="$HOME/.ssh/id_rsa" || \
        declare -gr glb_ssh_key="$HOME/.ssh/$cfg_ssh_key"

    [ -f $glb_base/lib/kernel ] && . $glb_base/lib/kernel
    [ -f $glb_base/lib/options ] && . $glb_base/lib/options
}

dev_base

if [ $# -ge 1 ] && [ "$1" == ":completion" ]; then
    shift; source $glb_base/lib/completion
else
    source $glb_base/lib/command
fi

# Call to main function. custom function declare before here.
dev_main $@

