#!/bin/sh
# Copyright 2016 The dev Authors. All rights reserved.
# Use of this source code is governed by a BSD-style
# license that can be found in the LICENSE file.

#
# Usage:
#     dev-installer <wkdir> <sudoer>
#

[ $# -lt 2 ] && echo "Usage: dev-installer <wkdir> <sudoer>" >&2 && exit 1

declare wkdir=$1 sudoer=$2 home

if [ "$sudoer" != "root" ] && [ "$(whoami)" != "$sudoer" ]; then
    home="/home/$sudoer"

    if ! getent passwd $sudoer; then
        # Create sudoer
        useradd --create-home $sudoer
        echo "$sudoer:dev" | chpasswd
        usermod -G wheel $sudoer
    fi

    # No-password
    mkdir -p /etc/sudoers.d
    echo "$sudoer ALL=NOPASSWD: ALL" > /etc/sudoers.d/$sudoer-nopasswd

    # Private and public key
    mkdir -m 700 -p $home/.ssh
    cp $HOME/.ssh/id_rsa* $home/.ssh
    cat $HOME/.ssh/id_rsa.pub > $home/.ssh/authorized_keys
    chown -R $sudoer:$sudoer $home/.ssh
    chmod 600 $home/.ssh/authorized_keys $home/.ssh/id_rsa*
fi

# Install
mkdir -p $wkdir && tar -xf $HOME/dev-init.tar -C $wkdir
mkdir -m a+w -p $wkdir/var/log $wkdir/var/tmp
touch $wkdir/var/log/127.0.0.1.err $wkdir/var/log/127.0.0.1.out
chown -R $sudoer:$sudoer $wkdir
rm -f $HOME/dev-init.tar $HOME/dev-installer
