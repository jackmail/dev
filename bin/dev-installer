#!/bin/sh
# Copyright 2016 The dev Authors. All rights reserved.
# Use of this source code is governed by a BSD-style
# license that can be found in the LICENSE file.

#
# Usage:
#     dev-installer <wkdir> <sudoer>
#

[ $# -lt 2 ] && echo "Usage: dev-installer <wkdir> <sudoer>" >&2 && exit 1

declare wkdir=$1 sudoer=$2 home="/root"

if [ "$sudoer" != "root" ] && [ "$(whoami)" == "$sudoer" ]; then
    home="/home/$sudoer"

    if ! getent passwd $sudoer; then
        # Create sudoer
        useradd --create-home $sudoer
        echo "$sudoer:dev" | chpasswd
        usermod -G wheel $sudoer
    fi

    # No-password
    mkdir -p /etc/sudoers.d
    echo "$sudoer ALL=NOPASSWD: ALL" > /etc/sudoers.d/$sudoer-nopasswd

    # Private and public key
    mkdir -m 700 -p $home/.ssh
    cp $HOME/.ssh/id_rsa* $home/.ssh
    cat $HOME/.ssh/id_rsa.pub > $home/.ssh/authorized_keys
    chown -R $sudoer:$sudoer $home/.ssh
    chmod 600 $home/.ssh/{authorized_keys,id_rsa*}
fi

# Install
sudo -u $sudoer mkdir -p $wkdir
sudo -u $sudoer tar -xf /tmp/dev-init.tar -C $wkdir
sudo -u $sudoer mkdir -m a+w -p $wkdir/var/{log,tmp}
sudo -u $sudoer touch $wkdir/var/log/127.0.0.1.{err,out}
rm -f /tmp/{dev-init.tar,dev-installer}

if [ ! -f $home/.bash_completion ]; then
    sudo -u $sudoer touch $home/.bash_completion
fi

if [ -f $wkdir/lib/completion ]; then
    grep -q "_dev_init_completion" $home/.bash_completion || \
        cat $wkdir/lib/completion >> $home/.bash_completion
fi
